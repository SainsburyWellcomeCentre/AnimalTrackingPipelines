Bootstrap: docker
From: conda/miniconda3

%post
    apt-get -y update 
    apt-get -y upgrade

    . /usr/local/etc/profile.d/conda.sh

    conda create -y --name jupyter python=3.8
    conda install -n jupyter -c conda-forge nodejs
    /usr/local/envs/jupyter/bin/python -m pip install --upgrade pip 
    /usr/local/envs/jupyter/bin/python -m pip install wheel ipywidgets jupyterlab jupyterlab-link-share

    mkdir -p /opt/jupyter
    echo -e '
    {
        "ServerApp": {
            "password": "argon2:$argon2id$v=19$m=10240,t=10,p=8$GApbmoWfAucdJxZJBhDo/Q$tM4jnP47IkDiuAPDqbuu0RpilVmWMjAxVTKM22qGUyE"
        }
    }
    ' > /opt/jupyter/jupyter_server_config.json

%environment
    # Automatically "conda init" so that environments can be activated
    . /usr/local/etc/profile.d/conda.sh
    conda activate jupyter


%runscript
    /usr/local/envs/jupyter/bin/jupyter lab --no-browser --ip "*" --collaborative --allow-root --config=/opt/jupyter/jupyter_server_config.json


# Python Jupyter Lab Kernel
%appinstall pythonkernel
    conda create -y --name python38 python=3.8
    conda install -n python38 ipykernel
    /usr/local/envs/python38/bin/python -m ipykernel install --name python --display-name "Python 3.8 (default)"
    /usr/local/envs/python38/bin/python -m pip install numpy matplotlib pandas pydantic
    

# R Jupyterlab Kernel
%appinstall rkernel

    # Set up R in a conda environment
    apt-get install -y libxrender-dev libxext-dev
    conda create -n rkernel r-recommended r-irkernel

    # Stupid workaround: removes all the optional "function " keywords from the bash scripts, which doesn't work when sh is running the script.
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/activate.d/activate-binutils_linux-64.sh > /usr/local/envs/rkernel/etc/conda/activate.d/activate-binutils_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/activate.d/activate-gcc_linux-64.sh > /usr/local/envs/rkernel/etc/conda/activate.d/activate-gcc_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/activate.d/activate-gfortran_linux-64.sh > /usr/local/envs/rkernel/etc/conda/activate.d/activate-gfortran_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/activate.d/activate-gxx_linux-64.sh > /usr/local/envs/rkernel/etc/conda/activate.d/activate-gxx_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/activate.d/activate-r-base.sh > /usr/local/envs/rkernel/etc/conda/activate.d/activate-r-base.sh

    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-binutils_linux-64.sh > /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-binutils_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-gcc_linux-64.sh > /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-gcc_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-gfortran_linux-64.sh > /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-gfortran_linux-64.sh
    sed 's/function //g' /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-gxx_linux-64.sh > /usr/local/envs/rkernel/etc/conda/deactivate.d/deactivate-gxx_linux-64.sh 
    
    # Install jupyter and the kernel
    conda activate rkernel
    conda install jupyterlab
    R -e 'IRkernel::installspec()'