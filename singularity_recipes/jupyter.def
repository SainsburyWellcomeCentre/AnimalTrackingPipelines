Bootstrap: docker
From: conda/miniconda3

%post
    apt-get -y update 
    apt-get -y upgrade
    conda update conda
    conda update --all

    . /usr/local/etc/profile.d/conda.sh
    conda activate base
    python -m pip install --upgrade pip 
    

    # https://towardsdatascience.com/how-to-set-up-anaconda-and-jupyter-notebook-the-right-way-de3b7623ea4a
    conda install conda-forge::jupyterlab conda-forge::nodejs conda-forge::nb_conda_kernels nbclassic==0.3.2
    pip install wheel ipywidgets jupyterlab-link-share 
    # jupyter server extension disable nbclassic
    
    apt-get install -y git-all
    pip install jupyterlab-git
    

%environment
    # Automatically "conda init" so that environments can be activated
    . /usr/local/etc/profile.d/conda.sh
    conda activate base

    # Set up password for jupyter
    mkdir -p /opt/jupyter
    echo '
    {
        "ServerApp": {
            "password": "argon2:$argon2id$v=19$m=10240,t=10,p=8$GApbmoWfAucdJxZJBhDo/Q$tM4jnP47IkDiuAPDqbuu0RpilVmWMjAxVTKM22qGUyE"
        }
    }
    ' > /opt/jupyter/jupyter_server_config.json


%runscript
    jupyter lab --no-browser --ip "*" --collaborative --allow-root --config=/opt/jupyter/jupyter_server_config.json


%appinstall pythonkernel
    conda create -n python38 pip python=3.8 ipykernel


%appinstall rkernel
    apt-get install -y libxrender-dev libxext-dev
    conda create -n rkernel r-recommended r-irkernel anaconda::fonts-anaconda r-cairo


%appinstall singularity
    # Install debian packages for dependencies
    apt-get install -y \
        build-essential \
        libseccomp-dev \
        pkg-config \
        squashfs-tools \
        cryptsetup \
        curl wget git

    # Install Go
    export GOVERSION=1.17.3 OS=linux ARCH=amd64  # change this as you need
    wget -O /tmp/go${GOVERSION}.${OS}-${ARCH}.tar.gz \
    https://dl.google.com/go/go${GOVERSION}.${OS}-${ARCH}.tar.gz
    tar -C /usr/local -xzf /tmp/go${GOVERSION}.${OS}-${ARCH}.tar.gz
    export PATH=$PATH:/usr/local/go/bin

    # Clone the Singularity repo
    git clone https://github.com/hpcng/singularity.git
    cd singularity

    # Checkout 3.8
    git -c advice.detachedHead=false checkout v3.8.4

    # Compile Singularity
    ./mconfig
    cd ./builddir
    make
    make install

%appenv singularity
    export PATH=$PATH:/usr/local/go/bin

%apptest singularity
    singularity version