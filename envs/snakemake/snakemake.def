Bootstrap: docker
From: conda/miniconda3

%help
    The snakemake workflow manager.  

%files
    ./envs/snakemake/snakemake_env.yml /etc/conda/environment.yml

%post
    apt-get -y update 
    apt-get -y upgrade
    conda env create -f /etc/conda/environment.yml -n snakemake

%environment
    # Automatically "conda init" so that environments can be activated
    . /usr/local/etc/profile.d/conda.sh
    conda activate snakemake
    # snakemake --bash-completion

%test
    conda --version
    snakemake --version
    dot -V

%runscript
    snakemake $*

%apprun dryrun
    snakemake --dry-run



### Simple app
%apphelp simple
    Run the pipeline with default working arguments.

%apprun simple
    snakemake --cores 1 --use-conda $*


### Rulegraph app
%apphelp rulegraph
    Uses Snakemake and Graphviz to render the rule graph DAG to an SVG

%appinstall rulegraph
    apt-get install -y graphviz

%apprun rulegraph
    snakemake --rulegraph | dot -Tsvg
    

%appinstall singularity
    # Install debian packages for dependencies
    apt-get install -y \
        build-essential \
        libseccomp-dev \
        pkg-config \
        squashfs-tools \
        cryptsetup \
        curl wget git

    # Install Go
    export GOVERSION=1.17.3 OS=linux ARCH=amd64  # change this as you need
    wget -O /tmp/go${GOVERSION}.${OS}-${ARCH}.tar.gz \
    https://dl.google.com/go/go${GOVERSION}.${OS}-${ARCH}.tar.gz
    tar -C /usr/local -xzf /tmp/go${GOVERSION}.${OS}-${ARCH}.tar.gz
    export PATH=$PATH:/usr/local/go/bin

    # Clone the Singularity repo
    git clone https://github.com/hpcng/singularity.git
    cd singularity

    # Checkout 3.8
    git -c advice.detachedHead=false checkout v3.8.4

    # Compile Singularity
    ./mconfig
    cd ./builddir
    make
    make install

%appenv singularity
    export PATH=$PATH:/usr/local/go/bin

%apptest singularity
    singularity version